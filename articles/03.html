<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Stacktrace #03 - The Elegant Hack That Prevents Both Deadlock AND Livelock
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        font-family: "Figtree", sans-serif;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              figtree: ["Figtree", "sans-serif"],
            },
            colors: {
              brand: {
                dark: "#09090b",
                darker: "#030303",
                accent: "#10b981",
                accent2: "#34d399",
                muted: "#52525b",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-zinc-950 min-h-screen p-8">
    <div class="max-w-4xl mx-auto space-y-12">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <div>
          <a
            href="../index.html"
            class="text-zinc-500 text-sm hover:text-zinc-300 mb-2 inline-block"
            >‚Üê Back to Brand</a
          >
          <h1 class="text-white text-2xl font-bold">Stacktrace #03</h1>
          <p class="text-zinc-500 text-sm mt-1">
            The Elegant Hack That Prevents Both Deadlock AND Livelock
          </p>
          <a
            href="03.md"
            class="text-emerald-400 text-sm hover:text-emerald-300 mt-2 inline-block"
            >‚Üí View Content (.md)</a
          >
        </div>
        <div class="text-zinc-600 text-sm font-mono">postgres/postgres</div>
      </div>

      <!-- DARK POSTER -->
      <div>
        <h2 class="text-white text-lg mb-4">Dark Style (600x600)</h2>

        <div
          id="poster-dark"
          class="w-[600px] h-[600px] bg-brand-dark relative overflow-hidden flex flex-col justify-between p-10"
          style="background: linear-gradient(145deg, #09090b 0%, #0f0f12 100%)"
        >
          <!-- Code lines decoration -->
          <div
            class="absolute top-0 right-0 w-64 h-full opacity-5 font-mono text-sm text-brand-accent leading-relaxed p-4 overflow-hidden"
          >
            if (TransactionIdPrecedes(<br />
            &nbsp;&nbsp;GetCurrentTransactionId(),<br />
            &nbsp;&nbsp;xwait))<br />
            {<br />
            &nbsp;&nbsp;/* I'm older, wait */<br />
            }<br />
            else<br />
            {<br />
            &nbsp;&nbsp;/* Back out, retry */<br />
            }
          </div>

          <!-- Top section -->
          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-2">
              <div class="text-brand-accent text-sm font-bold tracking-wider">
                STACKTRACE
              </div>
              <div class="flex-1 h-px bg-zinc-800"></div>
              <div class="text-zinc-600 text-sm font-mono">#03</div>
            </div>
          </div>

          <!-- Main title -->
          <div class="relative z-10 flex-1 flex flex-col justify-center">
            <h1 class="text-white text-4xl font-extrabold leading-tight mb-5">
              The Elegant Hack<br />
              That Prevents Both<br />
              <span class="text-brand-accent">Deadlock AND Livelock</span>
            </h1>
            <p class="text-zinc-500 text-lg leading-relaxed">
              One comparison. No locks.<br />
              PostgreSQL's INSERT ON CONFLICT.
            </p>
          </div>

          <!-- Bottom section -->
          <div class="relative z-10 flex justify-between items-end">
            <div class="flex items-center gap-3">
              <img
                src="https://media.licdn.com/dms/image/v2/D5603AQFHIgOiqEDSNQ/profile-displayphoto-shrink_800_800/B56ZYpjyJKHQAc-/0/1744453969775?e=1766016000&v=beta&t=ESRbMnoMriJeOwFpLl7vG1yFCb4VkYKK7_ajnjDxXRE"
                alt="@karngyan"
                class="w-12 h-12 rounded-full object-cover"
              />
              <div class="text-zinc-500 text-sm">@karngyan</div>
            </div>
            <div class="text-zinc-600 text-sm font-mono">postgres/postgres</div>
          </div>
        </div>
      </div>

      <!-- LIGHT POSTER -->
      <div>
        <h2 class="text-white text-lg mb-4">Light Style (600x600)</h2>

        <div
          id="poster-light"
          class="w-[600px] h-[600px] bg-white relative overflow-hidden flex flex-col justify-between p-10"
        >
          <!-- Accent bar -->
          <div
            class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-500 to-emerald-300"
          ></div>

          <!-- Top section -->
          <div class="relative z-10">
            <div class="text-emerald-600 text-sm font-bold tracking-wider">
              STACKTRACE #03
            </div>
          </div>

          <!-- Main title -->
          <div class="relative z-10 flex-1 flex flex-col justify-center">
            <h1
              class="text-neutral-900 text-4xl font-extrabold leading-tight mb-4"
            >
              The Elegant Hack That Prevents Deadlock AND Livelock
            </h1>
            <p class="text-neutral-500 text-lg leading-relaxed">
              One comparison. No locks. PostgreSQL's INSERT ON CONFLICT.
            </p>
          </div>

          <!-- Code snippet -->
          <div
            class="relative z-10 bg-zinc-100 rounded-xl p-5 font-mono text-sm text-zinc-600 mb-6"
          >
            <span class="text-zinc-400">// The one-line rule</span><br />
            <span class="text-emerald-600">TransactionIdPrecedes</span
            ><span class="text-zinc-500">(</span
            ><span class="text-zinc-700">myXID</span
            ><span class="text-zinc-500">,</span>
            <span class="text-zinc-700">theirXID</span
            ><span class="text-zinc-500">)</span>
          </div>

          <!-- Bottom section -->
          <div class="relative z-10 flex justify-between items-center">
            <div class="text-zinc-400 text-sm">by @karngyan</div>
            <div class="text-zinc-400 text-sm font-mono">
              src/backend/executor/execIndexing.c
            </div>
          </div>
        </div>
      </div>

      <!-- SQUARE SOCIAL (for Instagram/Twitter) -->
      <div>
        <h2 class="text-white text-lg mb-4">Square Social (600x600)</h2>

        <div
          id="poster-social"
          class="w-[600px] h-[600px] bg-brand-dark relative overflow-hidden flex flex-col justify-center items-center p-10"
          style="
            background: linear-gradient(
              145deg,
              #09090b 0%,
              #0c0c0e 50%,
              #09090b 100%
            );
          "
        >
          <!-- Grid pattern overlay -->
          <div
            class="absolute inset-0 opacity-10"
            style="
              background-image: linear-gradient(
                  rgba(16, 185, 129, 0.3) 1px,
                  transparent 1px
                ),
                linear-gradient(
                  90deg,
                  rgba(16, 185, 129, 0.3) 1px,
                  transparent 1px
                );
              background-size: 40px 40px;
            "
          ></div>

          <!-- Glow effect -->
          <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 h-80 rounded-full opacity-20"
            style="
              background: radial-gradient(circle, #10b981 0%, transparent 70%);
            "
          ></div>

          <!-- Content -->
          <div class="relative z-10 text-center">
            <div
              class="text-brand-accent text-sm font-bold tracking-wider mb-6"
            >
              STACKTRACE #03
            </div>
            <h1
              class="text-white text-4xl font-black tracking-tight mb-6 leading-tight"
            >
              The Elegant Hack<br />That Prevents<br /><span
                class="text-brand-accent"
                >Deadlock AND Livelock</span
              >
            </h1>
            <div class="w-24 h-1 bg-brand-accent mx-auto mb-6"></div>
            <p class="text-zinc-500 text-base leading-relaxed mb-8">
              One comparison. No locks.<br />
              PostgreSQL's INSERT ON CONFLICT.
            </p>
            <div class="text-brand-muted text-sm font-mono">by @karngyan</div>
          </div>
        </div>
      </div>

      <!-- WIDE BANNER (for Twitter/LinkedIn header) -->
      <div>
        <h2 class="text-white text-lg mb-4">Wide Banner (1200x600)</h2>

        <div
          id="poster-banner"
          class="w-[1200px] h-[600px] bg-brand-dark relative overflow-hidden flex p-12"
          style="background: linear-gradient(145deg, #09090b 0%, #0f0f12 100%)"
        >
          <!-- Code lines decoration -->
          <div
            class="absolute top-0 right-0 w-96 h-full opacity-5 font-mono text-base text-brand-accent leading-relaxed p-6 overflow-hidden"
          >
            /*<br />
            &nbsp;* To avoid livelock, one must<br />
            &nbsp;* back out first, then wait,<br />
            &nbsp;* while the other waits without<br />
            &nbsp;* backing out.<br />
            &nbsp;*<br />
            &nbsp;* The transaction with the<br />
            &nbsp;* higher XID backs out.<br />
            &nbsp;*/
          </div>

          <!-- Left content -->
          <div
            class="relative z-10 flex flex-col justify-between flex-1 max-w-2xl"
          >
            <div class="flex items-center gap-3">
              <div class="text-brand-accent text-base font-bold tracking-wider">
                STACKTRACE
              </div>
              <div class="w-24 h-px bg-zinc-800"></div>
              <div class="text-zinc-600 text-base font-mono">#03</div>
            </div>

            <div>
              <h1 class="text-white text-5xl font-extrabold leading-tight mb-6">
                The Elegant Hack<br />
                That Prevents Both<br />
                <span class="text-brand-accent">Deadlock AND Livelock</span>
              </h1>
              <p class="text-zinc-500 text-xl leading-relaxed max-w-lg">
                One comparison. No locks.<br />
                PostgreSQL's INSERT ON CONFLICT.
              </p>
            </div>

            <div class="flex justify-between items-end">
              <div class="flex items-center gap-3">
                <img
                  src="https://media.licdn.com/dms/image/v2/D5603AQFHIgOiqEDSNQ/profile-displayphoto-shrink_800_800/B56ZYpjyJKHQAc-/0/1744453969775?e=1766016000&v=beta&t=ESRbMnoMriJeOwFpLl7vG1yFCb4VkYKK7_ajnjDxXRE"
                  alt="@karngyan"
                  class="w-14 h-14 rounded-full object-cover"
                />
                <div class="text-zinc-500 text-base">@karngyan</div>
              </div>
              <div class="text-zinc-600 text-base font-mono">
                postgres/postgres
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LINKEDIN COVER (for article cover photo) -->
      <div>
        <h2 class="text-white text-lg mb-4">LinkedIn Cover (1920x1080)</h2>

        <div
          id="poster-linkedin-cover"
          class="w-[1920px] h-[1080px] bg-[#0a0a0a] relative overflow-hidden flex items-center justify-center"
        >
          <!-- Centered container -->
          <div class="font-mono text-left">
            <div class="text-zinc-500 text-3xl mb-6">
              // The livelock prevention rule
            </div>
            <div class="text-5xl leading-relaxed mb-4">
              <span class="text-zinc-400">if (</span
              ><span class="text-emerald-400">TransactionIdPrecedes</span
              ><span class="text-zinc-400">(</span>
            </div>
            <div class="text-5xl leading-relaxed mb-4 pl-12">
              <span class="text-zinc-100">myXID</span
              ><span class="text-zinc-400">,</span>
              <span class="text-zinc-100">theirXID</span
              ><span class="text-zinc-400">))</span>
            </div>
            <div class="text-5xl leading-relaxed mb-8 pl-8">
              <span class="text-zinc-500">// I'm older ‚Üí</span>
              <span class="text-emerald-400"> wait</span>
            </div>
            <div class="text-zinc-100 text-5xl font-bold mt-12">
              One rule prevents<br />
              <span class="text-emerald-400">both deadlock AND livelock.</span>
            </div>
            <div class="text-zinc-500 text-2xl mt-10">
              src/backend/executor/execIndexing.c:876
            </div>
          </div>
        </div>
      </div>

      <!-- DIVIDER -->
      <div class="border-t border-zinc-800 my-16"></div>
      <h2 class="text-white text-xl font-semibold mb-8">Blog Visuals</h2>

      <!-- VISUAL #1: Race Condition -->
      <div>
        <h3 class="text-zinc-400 text-sm mb-4">Two Transactions Racing</h3>

        <div
          id="visual-race"
          class="w-[640px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-zinc-300 text-lg font-semibold mb-6">
            Two Transactions, Same Key, Same Moment
          </div>

          <div class="space-y-4">
            <!-- Transaction A -->
            <div class="flex items-center gap-4">
              <div class="w-32 text-right">
                <span class="text-amber-400 font-mono text-sm">XID 100</span>
              </div>
              <div
                class="flex-1 bg-amber-500/20 border border-amber-400/50 rounded p-3"
              >
                <div class="font-mono text-sm text-amber-300">
                  INSERT INTO users VALUES ('alice@...')
                </div>
              </div>
            </div>

            <!-- Transaction B -->
            <div class="flex items-center gap-4">
              <div class="w-32 text-right">
                <span class="text-blue-400 font-mono text-sm">XID 101</span>
              </div>
              <div
                class="flex-1 bg-blue-500/20 border border-blue-400/50 rounded p-3"
              >
                <div class="font-mono text-sm text-blue-300">
                  INSERT INTO users VALUES ('alice@...')
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-center">
            <div class="text-zinc-500 text-sm">
              ‚Üì Both insert speculatively, both find conflict ‚Üì
            </div>
          </div>

          <div class="mt-4 border-t border-zinc-800 pt-4">
            <div class="text-zinc-500 text-xs">
              What happens now? Both see each other's tuple...
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #2: Deadlock -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">
          Option 1: Both Wait ‚Üí Deadlock
        </h3>

        <div
          id="visual-deadlock"
          class="w-[600px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-red-400 text-lg font-semibold mb-6">
            ‚ùå Both Wait ‚Üí DEADLOCK
          </div>

          <div class="flex justify-center items-center gap-12">
            <!-- Transaction A -->
            <div class="text-center">
              <div
                class="w-20 h-20 rounded-full bg-amber-500/20 border-2 border-amber-400 flex items-center justify-center mb-2"
              >
                <span class="text-amber-300 font-mono font-bold">A</span>
              </div>
              <div class="text-zinc-500 text-xs">XID 100</div>
              <div class="text-zinc-400 text-sm mt-2">Waiting for B...</div>
            </div>

            <!-- Arrows -->
            <div class="flex flex-col items-center gap-2">
              <div class="text-red-400 text-2xl">‚Üí</div>
              <div class="text-red-400 text-2xl">‚Üê</div>
            </div>

            <!-- Transaction B -->
            <div class="text-center">
              <div
                class="w-20 h-20 rounded-full bg-blue-500/20 border-2 border-blue-400 flex items-center justify-center mb-2"
              >
                <span class="text-blue-300 font-mono font-bold">B</span>
              </div>
              <div class="text-zinc-500 text-xs">XID 101</div>
              <div class="text-zinc-400 text-sm mt-2">Waiting for A...</div>
            </div>
          </div>

          <div class="mt-8 text-center">
            <div class="text-red-400 text-4xl mb-2">üíÄ</div>
            <div class="text-red-400 font-bold">Neither can proceed</div>
          </div>

          <div class="mt-6 border-t border-zinc-800 pt-4">
            <div class="text-zinc-500 text-xs">
              Deadlock detector will eventually kill one, but that's expensive.
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #3: Livelock -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">
          Option 2: Both Back Out ‚Üí Livelock
        </h3>

        <div
          id="visual-livelock"
          class="w-[680px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-amber-400 text-lg font-semibold mb-6">
            ‚ùå Both Back Out ‚Üí LIVELOCK
          </div>

          <div class="space-y-4">
            <!-- Step 1 -->
            <div class="flex items-center gap-4">
              <div class="w-8 text-zinc-600 text-sm">1</div>
              <div class="flex-1 flex gap-4">
                <div
                  class="flex-1 bg-amber-500/10 border border-amber-400/30 rounded p-2 text-center"
                >
                  <span class="text-amber-300 text-sm">A backs out</span>
                </div>
                <div
                  class="flex-1 bg-blue-500/10 border border-blue-400/30 rounded p-2 text-center"
                >
                  <span class="text-blue-300 text-sm">B backs out</span>
                </div>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="flex items-center gap-4">
              <div class="w-8 text-zinc-600 text-sm">2</div>
              <div class="flex-1 flex gap-4">
                <div
                  class="flex-1 bg-amber-500/10 border border-amber-400/30 rounded p-2 text-center"
                >
                  <span class="text-amber-300 text-sm">A waits for B</span>
                </div>
                <div
                  class="flex-1 bg-blue-500/10 border border-blue-400/30 rounded p-2 text-center"
                >
                  <span class="text-blue-300 text-sm">B waits for A</span>
                </div>
              </div>
            </div>

            <!-- Step 3 -->
            <div class="flex items-center gap-4">
              <div class="w-8 text-zinc-600 text-sm">3</div>
              <div class="flex-1 flex gap-4">
                <div
                  class="flex-1 bg-amber-500/10 border border-amber-400/30 rounded p-2 text-center"
                >
                  <span class="text-amber-300 text-sm">B is gone! Retry</span>
                </div>
                <div
                  class="flex-1 bg-blue-500/10 border border-blue-400/30 rounded p-2 text-center"
                >
                  <span class="text-blue-300 text-sm">A is gone! Retry</span>
                </div>
              </div>
            </div>

            <!-- Step 4 -->
            <div class="flex items-center gap-4">
              <div class="w-8 text-zinc-600 text-sm">4</div>
              <div class="flex-1 flex gap-4">
                <div
                  class="flex-1 bg-amber-500/10 border border-amber-400/30 rounded p-2 text-center"
                >
                  <span class="text-amber-300 text-sm">A inserts again</span>
                </div>
                <div
                  class="flex-1 bg-blue-500/10 border border-blue-400/30 rounded p-2 text-center"
                >
                  <span class="text-blue-300 text-sm">B inserts again</span>
                </div>
              </div>
            </div>

            <!-- Repeat -->
            <div class="flex justify-center">
              <div class="text-amber-400 text-2xl">üîÑ</div>
            </div>

            <div class="text-center text-amber-400 font-bold">
              Conflict again! Back to step 1...
            </div>
          </div>

          <div class="mt-6 border-t border-zinc-800 pt-4">
            <div class="text-zinc-500 text-xs">
              Worse than deadlock: no detector catches this. Spins forever.
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #4: The Solution -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">
          The Solution: XID-Based Tiebreaker
        </h3>

        <div
          id="visual-solution"
          class="w-[720px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-emerald-400 text-lg font-semibold mb-6">
            ‚úì Higher XID Backs Out
          </div>

          <div class="grid grid-cols-2 gap-8">
            <!-- Transaction A (Older) -->
            <div
              class="border border-amber-400/30 rounded-lg p-4 bg-amber-500/5"
            >
              <div class="flex items-center gap-2 mb-4">
                <div
                  class="w-10 h-10 rounded-full bg-amber-500/20 border border-amber-400 flex items-center justify-center"
                >
                  <span class="text-amber-300 font-mono text-sm font-bold"
                    >A</span
                  >
                </div>
                <div>
                  <div class="text-amber-300 font-mono text-sm">XID 100</div>
                  <div class="text-zinc-500 text-xs">Lower = Older</div>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="text-zinc-400">1. Insert speculatively</div>
                <div class="text-zinc-400">2. Find conflict with B</div>
                <div class="text-emerald-400 font-bold">
                  3. I'm older ‚Üí WAIT
                </div>
                <div class="text-zinc-500">4. (keep tuple in place)</div>
                <div class="text-zinc-400">5. B backs out</div>
                <div class="text-emerald-400">6. Complete insert ‚úì</div>
              </div>
            </div>

            <!-- Transaction B (Younger) -->
            <div class="border border-blue-400/30 rounded-lg p-4 bg-blue-500/5">
              <div class="flex items-center gap-2 mb-4">
                <div
                  class="w-10 h-10 rounded-full bg-blue-500/20 border border-blue-400 flex items-center justify-center"
                >
                  <span class="text-blue-300 font-mono text-sm font-bold"
                    >B</span
                  >
                </div>
                <div>
                  <div class="text-blue-300 font-mono text-sm">XID 101</div>
                  <div class="text-zinc-500 text-xs">Higher = Younger</div>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="text-zinc-400">1. Insert speculatively</div>
                <div class="text-zinc-400">2. Find conflict with A</div>
                <div class="text-blue-400 font-bold">
                  3. I'm younger ‚Üí BACK OUT
                </div>
                <div class="text-zinc-400">4. Wait for A</div>
                <div class="text-zinc-400">5. A completes</div>
                <div class="text-emerald-400">6. ON CONFLICT action ‚úì</div>
              </div>
            </div>
          </div>

          <div class="mt-6 border-t border-zinc-800 pt-4">
            <div class="text-zinc-500 text-xs">
              Asymmetric behavior from symmetric situations. Both complete!
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #5: Why XID Works -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">Why Transaction IDs Work</h3>

        <div
          id="visual-tiebreaker"
          class="w-[560px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-zinc-300 text-lg font-semibold mb-6">
            The Perfect Tiebreaker
          </div>

          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 flex items-center justify-center text-emerald-300 text-sm"
              >
                ‚úì
              </div>
              <div class="text-zinc-300">
                Unique ‚Äî Every transaction gets exactly one
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 flex items-center justify-center text-emerald-300 text-sm"
              >
                ‚úì
              </div>
              <div class="text-zinc-300">Comparable ‚Äî Clear ordering</div>
            </div>
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 flex items-center justify-center text-emerald-300 text-sm"
              >
                ‚úì
              </div>
              <div class="text-zinc-300">
                Free ‚Äî Already available, no extra work
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 flex items-center justify-center text-emerald-300 text-sm"
              >
                ‚úì
              </div>
              <div class="text-zinc-300">
                Consistent ‚Äî Both sides see the same values
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-400/50 flex items-center justify-center text-emerald-300 text-sm"
              >
                ‚úì
              </div>
              <div class="text-zinc-300">Deterministic ‚Äî No randomness</div>
            </div>
          </div>

          <div class="mt-6 border-t border-zinc-800 pt-4">
            <div class="text-zinc-500 text-xs">
              Both transactions independently determine who backs out, and they
              agree.
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #6: Full Flow -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">
          Full Speculative Insertion Flow
        </h3>

        <div
          id="visual-flow"
          class="w-[680px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-zinc-300 text-lg font-semibold mb-6">
            INSERT ... ON CONFLICT Flow
          </div>

          <div class="space-y-3">
            <!-- Step 1 -->
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-400 text-sm font-bold"
              >
                1
              </div>
              <div class="flex-1 bg-zinc-900 rounded p-3">
                <div class="text-zinc-300 text-sm">
                  Pre-check: Any committed conflict?
                </div>
              </div>
            </div>

            <div class="flex justify-center text-zinc-600">‚Üì</div>

            <!-- Step 2 -->
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-400 text-sm font-bold"
              >
                2
              </div>
              <div class="flex-1 bg-zinc-900 rounded p-3">
                <div class="text-zinc-300 text-sm">
                  Acquire speculative lock
                </div>
              </div>
            </div>

            <div class="flex justify-center text-zinc-600">‚Üì</div>

            <!-- Step 3 -->
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-400 text-sm font-bold"
              >
                3
              </div>
              <div class="flex-1 bg-zinc-900 rounded p-3">
                <div class="text-zinc-300 text-sm">
                  Insert tuple (marked speculative)
                </div>
              </div>
            </div>

            <div class="flex justify-center text-zinc-600">‚Üì</div>

            <!-- Step 4 - The XID Check -->
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded bg-emerald-500/30 border border-emerald-400 flex items-center justify-center text-emerald-300 text-sm font-bold"
              >
                4
              </div>
              <div
                class="flex-1 bg-emerald-500/10 border border-emerald-400/30 rounded p-3"
              >
                <div class="text-emerald-300 text-sm font-bold">
                  Check conflicts ‚Üí XID comparison!
                </div>
                <div class="text-zinc-500 text-xs mt-1">
                  Higher XID backs out. Lower XID waits.
                </div>
              </div>
            </div>

            <div class="flex justify-center text-zinc-600">‚Üì</div>

            <!-- Step 5 -->
            <div class="flex items-center gap-4">
              <div
                class="w-8 h-8 rounded bg-zinc-800 flex items-center justify-center text-zinc-400 text-sm font-bold"
              >
                5
              </div>
              <div class="flex-1 bg-zinc-900 rounded p-3">
                <div class="text-zinc-300 text-sm">
                  Mark as committed or killed
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #7: Pattern Applications -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">Where This Pattern Appears</h3>

        <div
          id="visual-pattern"
          class="w-[560px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="text-zinc-300 text-sm mb-4">
            Deterministic tiebreakers in distributed systems
          </div>

          <div class="space-y-3">
            <div class="flex items-center gap-4 p-3 bg-zinc-900 rounded">
              <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
              <div class="flex-1 text-zinc-300">PostgreSQL</div>
              <div class="text-zinc-500 text-sm">Transaction ID</div>
            </div>
            <div class="flex items-center gap-4 p-3 bg-zinc-900 rounded">
              <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
              <div class="flex-1 text-zinc-300">Lamport Clocks</div>
              <div class="text-zinc-500 text-sm">(timestamp, node_id)</div>
            </div>
            <div class="flex items-center gap-4 p-3 bg-zinc-900 rounded">
              <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
              <div class="flex-1 text-zinc-300">Raft Consensus</div>
              <div class="text-zinc-500 text-sm">(term, log_index)</div>
            </div>
            <div class="flex items-center gap-4 p-3 bg-zinc-900 rounded">
              <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
              <div class="flex-1 text-zinc-300">Bitcoin</div>
              <div class="text-zinc-500 text-sm">Block hash</div>
            </div>
            <div class="flex items-center gap-4 p-3 bg-zinc-900 rounded">
              <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
              <div class="flex-1 text-zinc-300">Ethernet</div>
              <div class="text-zinc-500 text-sm">MAC address</div>
            </div>
          </div>
        </div>
      </div>

      <!-- VISUAL #8: The Commit -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">The Original Commit</h3>

        <div
          id="visual-commit"
          class="w-[680px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="font-mono text-sm leading-relaxed">
            <div class="text-zinc-500">commit</div>
            <div class="text-emerald-400 mb-4">
              168d5805e4c08bed7b95d351bf097cff7c07dd65
            </div>
            <div class="text-zinc-500">
              Author: <span class="text-zinc-300">Andres Freund</span>
            </div>
            <div class="text-zinc-500 mb-4">
              Date: <span class="text-zinc-300">May 8, 2015</span>
            </div>
            <div class="text-zinc-300 font-bold mb-3">
              Add support for INSERT ... ON CONFLICT DO NOTHING/UPDATE.
            </div>
            <div class="text-zinc-500 text-xs leading-relaxed">
              This is implemented using a new infrastructure called "speculative
              insertion". It is an optimistic variant of regular insertion that
              first does a pre-check for existing tuples and then attempts an
              insert.
            </div>
          </div>

          <div class="mt-6 border-t border-zinc-800 pt-4 text-xs text-zinc-500">
            Authors: Peter Geoghegan, Heikki Linnakangas, Andres Freund
          </div>
        </div>
      </div>

      <!-- VISUAL #9: Lessons -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">Key Takeaways</h3>

        <div
          id="visual-lessons"
          class="w-[560px] bg-[#0a0a0a] p-8 border border-zinc-800"
        >
          <div class="space-y-4 text-sm">
            <div class="flex gap-4">
              <span class="text-zinc-600 w-4">1</span>
              <span class="text-zinc-400"
                >Consider both deadlock AND livelock in retry logic</span
              >
            </div>
            <div class="flex gap-4">
              <span class="text-zinc-600 w-4">2</span>
              <span class="text-zinc-400"
                >Break symmetry with deterministic tiebreakers</span
              >
            </div>
            <div class="flex gap-4">
              <span class="text-zinc-600 w-4">3</span>
              <span class="text-zinc-400"
                >Keep identifiers around ‚Äî you might need them</span
              >
            </div>
            <div class="flex gap-4">
              <span class="text-zinc-600 w-4">4</span>
              <span class="text-zinc-400"
                >Comment the "why," not just the "what"</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- DIVIDER -->
      <div class="border-t border-zinc-800 my-16"></div>
      <h2 class="text-white text-xl font-semibold mb-8">Code Snippets</h2>

      <!-- CODE #1: UPSERT Example -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">
          INSERT ... ON CONFLICT Example
        </h3>

        <div
          id="code-upsert"
          class="w-[680px] bg-[#0a0a0a] p-6 border border-zinc-800 rounded-lg"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="text-zinc-500 text-xs font-mono">SQL</div>
            <div class="flex gap-1.5">
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
            </div>
          </div>
          <div class="font-mono text-sm leading-relaxed text-zinc-300">
            <div>
              <span class="text-blue-400">INSERT INTO</span>
              <span class="text-white"> users </span
              ><span class="text-zinc-300">(</span
              ><span class="text-zinc-100">email</span
              ><span class="text-zinc-300">,</span>
              <span class="text-zinc-100">name</span
              ><span class="text-zinc-300">)</span>
            </div>
            <div>
              <span class="text-blue-400">VALUES</span>
              <span class="text-zinc-300">(</span
              ><span class="text-amber-300">'alice@example.com'</span
              ><span class="text-zinc-300">,</span>
              <span class="text-amber-300">'Alice'</span
              ><span class="text-zinc-300">)</span>
            </div>
            <div>
              <span class="text-emerald-400">ON CONFLICT</span>
              <span class="text-zinc-300">(</span
              ><span class="text-zinc-100">email</span
              ><span class="text-zinc-300">)</span>
              <span class="text-emerald-400">DO UPDATE SET</span>
              <span class="text-zinc-100">name</span>
              <span class="text-zinc-300">=</span>
              <span class="text-blue-400">EXCLUDED</span
              ><span class="text-zinc-300">.</span
              ><span class="text-zinc-100">name</span
              ><span class="text-zinc-300">;</span>
            </div>
          </div>
        </div>
      </div>

      <!-- CODE #2: The Comment -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">The Rule in Comments</h3>

        <div
          id="code-rule"
          class="w-[720px] bg-[#0a0a0a] p-6 border border-zinc-800 rounded-lg"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="text-zinc-500 text-xs font-mono">
              src/backend/executor/execIndexing.c:92-95
            </div>
            <div class="flex gap-1.5">
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
            </div>
          </div>
          <div class="font-mono text-sm leading-relaxed text-zinc-400">
            <div class="text-zinc-500">/*</div>
            <div>* To avoid the livelock, one of the backends must</div>
            <div>* back out first, and then wait, while the other</div>
            <div>* one waits without backing out. It doesn't matter</div>
            <div>* which one backs out, so we employ an arbitrary</div>
            <div class="text-emerald-400">
              &nbsp;* rule that the transaction with the higher XID
            </div>
            <div class="text-emerald-400">* backs out.</div>
            <div class="text-zinc-500">*/</div>
          </div>
        </div>
      </div>

      <!-- CODE #3: Wait Mode Enum -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">The Wait Mode Enum</h3>

        <div
          id="code-wait-mode"
          class="w-[600px] bg-[#0a0a0a] p-6 border border-zinc-800 rounded-lg"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="text-zinc-500 text-xs font-mono">
              src/backend/executor/execIndexing.c:122-128
            </div>
            <div class="flex gap-1.5">
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
            </div>
          </div>
          <div class="font-mono text-sm leading-relaxed text-zinc-300">
            <div>
              <span class="text-blue-400">typedef enum</span>
            </div>
            <div class="text-zinc-300">{</div>
            <div class="pl-4">
              <span class="text-zinc-100">CEOUC_WAIT</span
              ><span class="text-zinc-300">,</span>
              <span class="text-zinc-500 ml-16">/* Normal waiting */</span>
            </div>
            <div class="pl-4">
              <span class="text-zinc-100">CEOUC_NOWAIT</span
              ><span class="text-zinc-300">,</span>
              <span class="text-zinc-500 ml-12">/* Don't wait */</span>
            </div>
            <div class="pl-4 bg-emerald-500/10 -mx-2 px-2 py-1 rounded">
              <span class="text-emerald-400"
                >CEOUC_LIVELOCK_PREVENTING_WAIT</span
              ><span class="text-zinc-300">,</span>
            </div>
            <div>
              <span class="text-zinc-300">}</span>
              <span class="text-zinc-100">CEOUC_WAIT_MODE</span
              ><span class="text-zinc-300">;</span>
            </div>
          </div>
        </div>
      </div>

      <!-- CODE #4: The XID Check -->
      <div class="mt-12">
        <h3 class="text-zinc-400 text-sm mb-4">The XID Comparison</h3>

        <div
          id="code-xid-check"
          class="w-[720px] bg-[#0a0a0a] p-6 border border-zinc-800 rounded-lg"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="text-zinc-500 text-xs font-mono">
              src/backend/executor/execIndexing.c:876-880
            </div>
            <div class="flex gap-1.5">
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
              <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
            </div>
          </div>
          <div class="font-mono text-sm leading-relaxed text-zinc-300">
            <div>
              <span class="text-blue-400">if</span>
              <span class="text-zinc-300">(</span
              ><span class="text-zinc-100">TransactionIdIsValid</span
              ><span class="text-zinc-300">(</span
              ><span class="text-amber-300">xwait</span
              ><span class="text-zinc-300">)</span>
              <span class="text-zinc-300">&&</span>
            </div>
            <div class="pl-4">
              <span class="text-zinc-300">(</span
              ><span class="text-zinc-100">waitMode</span>
              <span class="text-zinc-300">==</span>
              <span class="text-zinc-100">CEOUC_WAIT</span>
              <span class="text-zinc-300">||</span>
            </div>
            <div class="pl-5">
              <span class="text-zinc-300">(</span
              ><span class="text-zinc-100">waitMode</span>
              <span class="text-zinc-300">==</span>
              <span class="text-emerald-400"
                >CEOUC_LIVELOCK_PREVENTING_WAIT</span
              >
              <span class="text-zinc-300">&&</span>
            </div>
            <div class="pl-6">
              <span class="text-zinc-100">DirtySnapshot</span
              ><span class="text-zinc-300">.</span
              ><span class="text-amber-300">speculativeToken</span>
              <span class="text-zinc-300">&&</span>
            </div>
            <div class="pl-6 bg-emerald-500/10 -mx-2 px-2 py-1 rounded">
              <span class="text-emerald-400">TransactionIdPrecedes</span
              ><span class="text-zinc-300">(</span
              ><span class="text-zinc-100">GetCurrentTransactionId</span
              ><span class="text-zinc-300">(),</span>
              <span class="text-amber-300">xwait</span
              ><span class="text-zinc-300">))))</span>
            </div>
            <div class="text-zinc-300">{</div>
            <div class="pl-4 text-zinc-500">
              /* Wait for the other transaction */
            </div>
            <div class="text-zinc-300">}</div>
          </div>
          <div class="mt-4 pt-4 border-t border-zinc-800">
            <div class="text-zinc-500 text-xs">
              If my XID is lower (I'm older), I wait. If higher, I back out.
            </div>
          </div>
        </div>
      </div>

      <!-- INSTRUCTIONS -->
      <div class="bg-zinc-900 rounded-lg p-6 text-zinc-300 text-sm mt-12">
        <h3 class="font-bold text-white mb-2">How to Export</h3>
        <ol class="list-decimal list-inside space-y-1">
          <li>Right-click on a poster/visual ‚Üí Inspect</li>
          <li>Right-click the element ‚Üí Capture node screenshot</li>
          <li>
            Or use a browser extension like "GoFullPage" or "Awesome Screenshot"
          </li>
        </ol>
      </div>
    </div>
  </body>
</html>
